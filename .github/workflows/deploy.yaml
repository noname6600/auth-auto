name: CI/CD Deploy Microservices

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      KUBECONFIG: ${{ secrets.KUBECONFIG }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # Build + Push auth-service
    - name: Build auth-service Docker image
      run: docker build -t $DOCKERHUB_USERNAME/auth-service:latest ./auth-service

    - name: Login to DockerHub
      run: echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin

    - name: Push auth-service image
      run: docker push $DOCKERHUB_USERNAME/auth-service:latest

    # Build + Push order-service
    - name: Build order-service Docker image
      run: docker build -t $DOCKERHUB_USERNAME/order-service:latest ./order-service

    - name: Push order-service image
      run: docker push $DOCKERHUB_USERNAME/order-service:latest

    # Setup kubectl
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: v1.33.6

    - name: Configure Kubeconfig
      env:
        KUBECONFIG_BASE64: ${{ secrets.KUBECONFIG_BASE64 }}
      run: |
        mkdir -p $HOME/.kube
        echo "$KUBECONFIG_BASE64" | base64 --decode > $HOME/.kube/config
        chmod 600 $HOME/.kube/config

    - name: Debug kubeconfig
      run: |
        echo "===== file size (bytes) ====="
        wc -c $HOME/.kube/config || true
        echo "===== first 20 lines ====="
        head -n 20 $HOME/.kube/config || true
        echo "===== check first token (should be apiVersion) ====="
        awk 'NR==1{print; exit}' $HOME/.kube/config || true

    - name: Test kubectl connectivity
      run: |
        kubectl version --client=true
        kubectl config view --minify
        kubectl get nodes || true

    # Deploy MySQL
    - name: Deploy MySQL
      run: kubectl apply -f ./k8s/mysql.yaml

    # Deploy auth-service
    - name: Deploy auth-service
      run: kubectl apply -f ./k8s/auth.yaml

    # Deploy order-service
    - name: Deploy order-service
      run: kubectl apply -f ./k8s/order.yaml

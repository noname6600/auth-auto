name: CI/CD Deploy Microservices

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      KUBECONFIG_BASE64: ${{ secrets.KUBECONFIG_BASE64 }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Docker login
      run: echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin

    # Build & push services
    - name: Build auth-service
      run: docker build -t $DOCKERHUB_USERNAME/auth-service:latest ./auth-service
    - name: Push auth-service
      run: docker push $DOCKERHUB_USERNAME/auth-service:latest

    - name: Build order-service
      run: docker build -t $DOCKERHUB_USERNAME/order-service:latest ./order-service
    - name: Push order-service
      run: docker push $DOCKERHUB_USERNAME/order-service:latest

    - name: Build frontend
      run: docker build -t $DOCKERHUB_USERNAME/frontend:latest ./frontend
    - name: Push frontend
      run: docker push $DOCKERHUB_USERNAME/frontend:latest

    - name: Build envoy
      run: docker build -t $DOCKERHUB_USERNAME/envoy:latest ./k8s/envoy-gateway
    - name: Push envoy
      run: docker push $DOCKERHUB_USERNAME/envoy:latest

    # Setup kubectl
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: v1.33.6

    - name: Configure kubeconfig
      run: |
        mkdir -p $HOME/.kube
        echo "$KUBECONFIG_BASE64" | base64 --decode > $HOME/.kube/config
        chmod 600 $HOME/.kube/config

    # Deploy services
    - name: Deploy auth
      run: kubectl apply -f k8s/auth.yaml
    - name: Deploy order
      run: kubectl apply -f k8s/order.yaml
    - name: Deploy frontend
      run: kubectl apply -f k8s/frontend.yaml

    # Deploy envoy
    - name: Deploy Envoy ConfigMap
      run: kubectl create configmap envoy-config --from-file=k8s/envoy-gateway/envoy-config.yaml -o yaml --dry-run=client | kubectl apply -f -
    - name: Deploy Envoy Deployment
      run: kubectl apply -f k8s/envoy-gateway/deployment.yaml
    - name: Deploy Envoy Service
      run: kubectl apply -f k8s/envoy-gateway/service.yaml

    # Deploy Ingress
    - name: Deploy API Ingress
      run: kubectl apply -f k8s/api-ingress.yaml
    - name: Deploy Frontend Ingress
      run: kubectl apply -f k8s/frontend-ingress.yaml
